<!doctype html>
<html lang="pl">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="description" content="Narzędzie do audytu deklaracji dostępności – szybka lista kontrolna zgodności z Warunkami Technicznymi, eksport raportu HTML/JSON, lokalny zapis szkicu." />
    <meta name="color-scheme" content="light dark" />
    <title>Audytor Deklaracji Dostępności — zgodność z warunkami technicznymi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
    <style>
        :root {
            color-scheme: light dark;
            --color-text: #111111;
            --color-muted: #1f1f1f;
            --color-background: #f4f6f8;
            --color-surface: #ffffff;
            --color-border: #c5d3e1;
            --color-focus: #ff8c00;
            --color-primary: #0b3d91;
            --color-primary-dark: #072c6c;
            --color-success: #0c4a2f;
            --color-success-dark: #093521;
            --color-danger: #7a0c00;
            --color-danger-dark: #4f0600;
            --color-info: #03506f;
            --color-info-dark: #023a52;
            --color-warning: #523000;
            --color-warning-dark: #3b2200;
            --color-secondary: #2e2e2e;
            --color-choice-active-text: #ffffff;
            --color-quote-bg: #eef2f6;
            --color-quote-border: #274a75;
            --shadow-card: 0 2px 6px rgba(9, 17, 34, 0.08);
            --color-on-primary: #ffffff;
            --color-on-secondary: #ffffff;
            --color-on-success: #ffffff;
            --color-on-danger: #ffffff;
            --color-on-info: #ffffff;
            --color-on-warning: #ffffff;
            --color-success-status: #0c4a2f;
            --color-warning-status: #523000;
            --color-danger-status: #7a0c00;
            --color-primary-surface: #0b3d91;
            --color-success-surface: #0c4a2f;
            --color-danger-surface: #7a0c00;
            --color-info-surface: #03506f;
            --color-warning-surface: #523000;
        }

        body[data-theme="dark"] {
            --color-text: #f9fbff;
            --color-muted: #cfd8e3;
            --color-background: #0f141d;
            --color-surface: #1a2433;
            --color-border: #36435a;
            --color-focus: #ffc15a;
            --color-primary: #9cc9ff;
            --color-primary-surface: #0f3d8d;
            --color-primary-dark: #0b2f6a;
            --color-success: #7ce2b4;
            --color-success-surface: #0f6f47;
            --color-success-dark: #0a5538;
            --color-danger: #ff9b8a;
            --color-danger-surface: #962417;
            --color-danger-dark: #70180f;
            --color-info: #7ec2ff;
            --color-info-surface: #1f5f85;
            --color-info-dark: #164a66;
            --color-warning: #ffd27c;
            --color-warning-surface: #b57d0a;
            --color-warning-dark: #8a5f08;
            --color-secondary: #d8e2f2;
            --color-choice-active-text: #0b1728;
            --color-quote-bg: #223044;
            --color-quote-border: #7ec2ff;
            --shadow-card: 0 8px 18px rgba(0, 0, 0, 0.45);
            --color-on-primary: #ffffff;
            --color-on-secondary: #0b1728;
            --color-on-success: #ffffff;
            --color-on-danger: #ffffff;
            --color-on-info: #ffffff;
            --color-on-warning: #1d1300;
            --color-success-status: #7ce2b4;
            --color-warning-status: #ffd27c;
            --color-danger-status: #ff9b8a;
        }

        body {
            padding: 1rem;
            background: var(--color-background);
            color: var(--color-text);
            font-family: system-ui, "Segoe UI", Roboto, Arial;
            line-height: 1.6;
            transition: background-color 0.25s ease, color 0.25s ease;
        }

        main {
            background: transparent;
        }

        .container {
            max-width: 1040px;
        }

        h1, h2, h3, h4, h5, h6,
        .h1, .h2, .h3, .h4, .h5, .h6 {
            color: var(--color-text);
        }

        .card {
            margin-bottom: 1rem;
            border: 1px solid var(--color-border);
            border-radius: 0.75rem;
            background-color: var(--color-surface);
            box-shadow: var(--shadow-card);
            color: var(--color-text);
        }

        .card p,
        .card span,
        .card li,
        .card strong,
        .card label {
            color: var(--color-text);
        }

        .skip-link {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            background: var(--color-primary-surface);
            color: var(--color-on-primary);
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            transform: translateY(-120%);
            transition: transform 0.2s ease;
            z-index: 1000;
        }

        .skip-link:focus-visible {
            transform: translateY(0);
            outline: 3px solid var(--color-focus);
            outline-offset: 4px;
        }

        .small-muted {
            font-size: 1rem;
            color: var(--color-muted);
        }

        label, legend {
            font-weight: 600;
            color: var(--color-text);
        }

        .form-control {
            width: 100%;
            border: 2px solid var(--color-border);
            border-radius: 0.5rem;
            padding: 0.65rem 0.75rem;
            font-size: 1rem;
            line-height: 1.4;
            color: var(--color-text);
            background-color: var(--color-surface);
            transition: background-color 0.25s ease, color 0.25s ease, border-color 0.25s ease, box-shadow 0.25s ease;
            margin: 0;
            min-height: 2.75rem;
        }

        .form-control-sm {
            padding: 0.5rem 0.75rem;
            min-height: 2.4rem;
        }

        .form-control:focus-visible {
            outline: 3px solid var(--color-focus);
            outline-offset: 2px;
            border-color: var(--color-focus);
            box-shadow: none;
        }

        textarea.form-control {
            min-height: 6rem;
            resize: vertical;
        }

        .form-control::placeholder {
            color: var(--color-muted);
            opacity: 0.8;
        }

        body[data-theme="dark"] .form-control {
            background-color: #1f2e44;
            border-color: #3a4d6a;
            color: var(--color-text);
        }

        .row-item {
            border: 2px solid var(--color-border);
            border-radius: 0.75rem;
            padding: 1.25rem 1.5rem 1.25rem 1.25rem;
            margin-bottom: 1rem;
            background: var(--color-surface);
            color: var(--color-text);
            position: relative;
        }

        .row-title {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            display: block;
            padding-right: 5rem;
        }

        .row-description {
            margin-bottom: 0.75rem;
        }

        .row-description.flag-required {
            color: var(--color-warning-status);
        }

        .row-description.flag-optional {
            color: var(--color-info);
        }

        .badge-wrapper {
            position: absolute;
            top: 1rem;
            right: 1rem;
        }

        .badge-found,
        .badge-miss,
        .badge-nd {
            display: inline-block;
            padding: 0.35rem 0.75rem;
            border-radius: 999px;
            font-weight: 600;
            font-size: 0.95rem;
            border: 2px solid currentColor;
            background: var(--color-surface);
        }

        .badge-found {
            color: var(--color-success-status);
        }

        .badge-miss {
            color: var(--color-danger-status);
        }

        .badge-nd {
            color: var(--color-info);
        }

        .badge-wrapper .badge-icon {
            margin-right: 0.4rem;
            font-size: 1.05rem;
            line-height: 1;
            vertical-align: middle;
        }

        .visually-hidden {
            position: absolute !important;
            width: 1px !important;
            height: 1px !important;
            padding: 0 !important;
            margin: -1px !important;
            overflow: hidden !important;
            clip: rect(0, 0, 0, 0) !important;
            white-space: nowrap !important;
            border: 0 !important;
        }

        .choice-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .choice-label {
            display: inline-flex;
            align-items: center;
            justify-content: flex-start;
            flex-direction: row;
            gap: 0.6rem;
            padding: 0.9rem 1.25rem;
            border: 2px solid var(--color-secondary);
            border-radius: 0.65rem;
            background: var(--color-surface);
            color: var(--color-secondary);
            font-weight: 600;
            cursor: pointer;
            min-width: 9rem;
            transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
            text-align: left;
        }

        .choice-label input[type="radio"] {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }

        .choice-label-text {
            display: inline-flex;
            align-items: center;
            justify-content: flex-start;
        }


        .choice-label[data-choice="ok"] {
            border-color: var(--color-success-status);
            color: var(--color-success-status);
        }

        .choice-label[data-choice="no"] {
            border-color: var(--color-danger-status);
            color: var(--color-danger-status);
        }

        .choice-label[data-choice="na"] {
            border-color: var(--color-info);
            color: var(--color-info);
        }

        .choice-label[data-choice="ok"]:hover,
        .choice-label[data-choice="ok"]:focus-within {
            border-color: var(--color-success-surface);
        }

        .choice-label[data-choice="no"]:hover,
        .choice-label[data-choice="no"]:focus-within {
            border-color: var(--color-danger-surface);
        }

        .choice-label[data-choice="na"]:hover,
        .choice-label[data-choice="na"]:focus-within {
            border-color: var(--color-info-surface);
        }

        .choice-label:focus-within {
            outline: 3px solid var(--color-focus);
            outline-offset: 3px;
        }

        .choice-label[data-choice="ok"][data-state="checked"],
        .choice-label[data-choice="ok"] input[type="radio"]:checked ~ .choice-label-text {
            background-color: var(--color-success-surface);
            border-color: var(--color-success-surface);
            color: var(--color-on-success);
        }

        .choice-label[data-choice="no"][data-state="checked"],
        .choice-label[data-choice="no"] input[type="radio"]:checked ~ .choice-label-text {
            background-color: var(--color-danger-surface);
            border-color: var(--color-danger-surface);
            color: var(--color-on-danger);
        }

        .choice-label[data-choice="na"][data-state="checked"],
        .choice-label[data-choice="na"] input[type="radio"]:checked ~ .choice-label-text {
            background-color: var(--color-info-surface);
            border-color: var(--color-info-surface);
            color: var(--color-on-info);
        }

        .choice-comment {
            max-width: 100%;
        }

        details {
            margin-top: 0.75rem;
            margin-bottom: 0.25rem;
        }

        details summary {
            font-weight: 600;
            cursor: pointer;
            color: var(--color-text);
        }

        details summary:focus-visible {
            outline: 3px solid var(--color-focus);
            outline-offset: 4px;
        }

        pre.quote {
            background: var(--color-quote-bg);
            border-left: 4px solid var(--color-quote-border);
            padding: 0.75rem;
            font-family: system-ui, "Segoe UI", Roboto, Arial;
            font-style: italic;
            font-size: 1rem;
            white-space: pre-wrap;
            border-radius: 0.5rem;
            color: var(--color-text);
        }

        .btn {
            font-weight: 700;
            border-radius: 0.65rem;
            border-width: 2px;
            letter-spacing: 0.01em;
            padding: 0.6rem 1.1rem;
            min-height: 2.75rem;
            transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
        }

        .btn:focus-visible {
            outline: 3px solid var(--color-focus);
            outline-offset: 2px;
        }

        .btn-primary {
            background-color: var(--color-primary-surface);
            border-color: var(--color-primary-surface);
            color: var(--color-on-primary);
        }

        .btn-primary:hover,
        .btn-primary:focus-visible {
            background-color: var(--color-primary-dark);
            border-color: var(--color-primary-dark);
        }

        .btn-outline-secondary {
            background-color: var(--color-surface);
            color: var(--color-secondary);
            border-color: var(--color-secondary);
        }

        .btn-outline-secondary:hover,
        .btn-outline-secondary:focus-visible {
            background-color: var(--color-secondary);
            color: var(--color-on-secondary);
        }

        .btn-outline-warning {
            background-color: var(--color-surface);
            color: var(--color-warning);
            border-color: var(--color-warning);
        }

        .btn-outline-warning:hover,
        .btn-outline-warning:focus-visible {
            background-color: var(--color-warning-surface);
            color: var(--color-on-warning);
            border-color: var(--color-warning-surface);
        }

        .btn-outline-primary {
            background-color: var(--color-surface);
            color: var(--color-primary);
            border-color: var(--color-primary);
        }

        .btn-outline-primary:hover,
        .btn-outline-primary:focus-visible {
            background-color: var(--color-primary-surface);
            color: var(--color-on-primary);
            border-color: var(--color-primary-surface);
        }

        .btn-outline-info {
            background-color: var(--color-surface);
            color: var(--color-info);
            border-color: var(--color-info);
        }

        .btn-outline-info:hover,
        .btn-outline-info:focus-visible {
            background-color: var(--color-info-surface);
            color: var(--color-on-info);
            border-color: var(--color-info-surface);
        }

        .btn-outline-danger {
            background-color: var(--color-surface);
            color: var(--color-danger);
            border-color: var(--color-danger);
        }

        .btn-outline-danger:hover,
        .btn-outline-danger:focus-visible {
            background-color: var(--color-danger-surface);
            color: var(--color-on-danger);
            border-color: var(--color-danger-surface);
        }

        .btn-outline-info input[type="file"] {
            cursor: pointer;
        }

        .btn-success {
            background-color: var(--color-success-surface);
            border-color: var(--color-success-surface);
            color: var(--color-on-success);
        }

        .btn-success:hover,
        .btn-success:focus-visible {
            background-color: var(--color-success-dark);
            border-color: var(--color-success-dark);
        }

        .btn-danger {
            background-color: var(--color-danger-surface);
            border-color: var(--color-danger-surface);
            color: var(--color-on-danger);
        }

        .btn-danger:hover,
        .btn-danger:focus-visible {
            background-color: var(--color-danger-dark);
            border-color: var(--color-danger-dark);
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .controls-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            align-items: center;
        }

        .header-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            align-items: center;
            margin-top: 0.75rem;
        }

        .theme-toggle {
            min-width: 13rem;
        }

        .controls-row .btn {
            min-width: 6.5rem;
        }

        .no-print {
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .status-positive {
            color: var(--color-success-status);
            font-weight: 700;
        }

        .status-warning {
            color: var(--color-warning-status);
            font-weight: 700;
        }

        .status-danger {
            color: var(--color-danger-status);
            font-weight: 700;
        }

        .quote + .small-muted {
            margin-top: 0.75rem;
        }

        footer {
            margin-top: 1.5rem;
        }

        a {
            color: var(--color-primary);
            text-decoration: underline;
            text-decoration-thickness: 0.15em;
        }

        a:focus-visible {
            outline: 3px solid var(--color-focus);
            outline-offset: 2px;
        }

        @media (max-width: 720px) {
            body {
                padding: 0.5rem;
            }

            .choice-group {
                flex-direction: column;
            }

            .choice-label {
                width: 100%;
                justify-content: center;
            }
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }

        @media print {
            .no-print {
                display: none !important;
            }

            body {
                background: #ffffff;
                padding: 0;
            }

            main {
                margin: 0;
            }
        }
    </style>
</head>

<body>
    <a class="skip-link" href="#mainContent">Przejdź do głównej treści</a>
    <a class="skip-link" href="#auditMetaHeading">Przejdź do danych audytu</a>
    <a class="skip-link" href="#sequenceSection">Przejdź do sekwencji</a>
    <a class="skip-link" href="#checklistSection">Przejdź do checklisty</a>
    <a class="skip-link" href="#auditResultsSection">Przejdź do wyników audytu</a>
    <noscript>
        <div class="alert alert-warning m-3">To narzędzie wymaga włączonej obsługi JavaScript.</div>
    </noscript>
    <main id="mainContent" class="container" role="main">
        <header class="mb-3" role="banner">
            <h1>Audytor Deklaracji Dostępności</h1>
            <p class="small-muted">Wklej deklarację, wykonaj weryfikację pozycji (Spełnione / Niespełnione / Nie
                dotyczy). Każdy punkt zawiera rozwijany fragment: cytat z Warunków Technicznych oraz przejrzystą
                parafrazę.</p>
            <div class="header-actions">
                <button id="themeToggle" class="btn btn-outline-secondary theme-toggle" type="button" aria-pressed="false">Przełącz na ciemny motyw</button>
                <span class="small-muted">Zmiana motywu dotyczy wyłącznie tego narzędzia.</span>
            </div>
        </header>

        <section class="card p-3 mb-3" id="auditMetaHeading" aria-labelledby="auditMetaHeading">
            <h2 id="auditMetaHeading" class="h5">Dane audytu</h2>
            <div class="mb-2">
                <label class="form-label" for="auditDate">Data audytu</label>
                <input id="auditDate" type="date" class="form-control form-control-sm" aria-describedby="auditDateHint">
                <p class="small-muted" id="auditDateHint">Podaj datę w formacie rrrr-mm-dd. Pole obowiązkowe do
                    eksportu.</p>
            </div>
            <div class="mb-2">
                <label class="form-label" for="authorName">Autor raportu</label>
                <input id="authorName" type="text" class="form-control form-control-sm" placeholder="Imię i nazwisko / zespół" aria-describedby="authorHint">
                <p class="small-muted" id="authorHint">Wpisz osobę lub zespół odpowiedzialny za audyt.</p>
            </div>

            <div class="mb-2">
                <label class="form-label" for="entityName">Podmiot / Strona (nazwa lub URL)</label>
                <input id="entityName" type="text" class="form-control" placeholder="np. Urząd Miasta X / https://..." aria-describedby="entityHint">
                <p class="small-muted" id="entityHint">Określ stronę lub aplikację mobilną, której dotyczy audyt.</p>
            </div>

            <div class="mb-2">
                <label class="form-label" for="declarationText">Wklej treść deklaracji (HTML lub czysty tekst)</label>
                <textarea id="declarationText" rows="8" class="form-control"
                    placeholder="Wklej tutaj treść deklaracji... (np. źródło HTML deklaracji)" aria-describedby="declarationHint"></textarea>
                <p class="small-muted" id="declarationHint">Zawartość pozostaje lokalnie w Twojej przeglądarce.</p>
            </div>

            <div class="controls-row">
                <button id="prefillBtn" class="btn btn-primary" type="button">Wstępna analiza fraz</button>
                <button id="clearBtn" class="btn btn-outline-secondary" type="button">Wyczyść deklarację</button>
                <div class="ms-auto small-muted align-self-center">Opracowano na podstawie <a
                        href="https://mc.bip.gov.pl/objasnienia-prawne/warunki-techniczne-publikacji-oraz-struktura-dokumentu-elektronicznego-deklaracji-dostepnosci.html">Warunków
                        technicznych publikacji oraz struktury dokumentu elektronicznego deklaracji dostępności</a>.
                </div>
            </div>
        </section>

        <section class="card p-3 mt-2" id="sequenceSection" aria-labelledby="sequenceHeading">
            <h2 id="sequenceHeading" class="h5 mb-2">Analiza kolejności sekcji</h2>
            <p id="sequenceResult" class="small-muted mb-0" role="status" aria-live="polite" aria-atomic="true">Brak wklejonej treści do analizy kolejności.</p>
        </section>

        <section id="checklistSection" aria-label="Checklist weryfikacyjny elementów deklaracji"></section>

        <section class="card p-3 mt-3" id="auditResultsSection" aria-labelledby="auditResultsHeading">
            <h2 id="auditResultsHeading" class="h5">Wynik audytu</h2>
            <div id="scoreStatus" role="status" aria-live="polite" aria-atomic="true">
                <div class="mb-2"><strong>Procent zgodności:</strong> <span id="scorePerc">—</span></div>
                <div class="mb-2"><strong>Ocena opisowa:</strong> <span id="scoreLabel">—</span></div>
            </div>
            <div class="mb-2"><strong>Braki / krytyczne pozycje:</strong>
                <ul id="missingList" aria-live="polite" aria-label="Lista braków i pozycji wymagających uwagi"></ul>
            </div>
            <div class="d-flex gap-2 no-print">
                <button id="saveDraftBtn" class="btn btn-outline-warning" type="button">Zapisz szkic</button>
                <button id="exportJsonBtn" class="btn btn-outline-primary" type="button">Eksportuj JSON</button>
                <input id="importJson" type="file" accept="application/json" class="visually-hidden" aria-hidden="true" tabindex="-1">
                <button id="importJsonBtn" class="btn btn-outline-info" type="button">Importuj JSON</button>
                <button id="exportHtmlBtn" class="btn btn-success" type="button">Eksportuj raport (HTML)</button>
                <button id="resetBtn" class="btn btn-danger ms-auto" type="button">Resetuj</button>
            </div>
        </section>

        <footer class="text-center small-muted mt-3 mb-3" role="contentinfo"><a href="https://github.com/MStankiewiczOfficial/audytor-deklaracji-dostepnosci" target="_blank" rel="noopener">Kod źródłowy</a></footer>
    </main>
    <script>
    const THEME_KEY = 'audyt-theme-preference';
    const prefersDarkQuery = typeof window.matchMedia === 'function' ? window.matchMedia('(prefers-color-scheme: dark)') : null;
        let userSelectedTheme = false;

        function updateThemeToggle(theme) {
            const btn = document.getElementById('themeToggle');
            if (!btn) return;
            const isDark = theme === 'dark';
            btn.setAttribute('aria-pressed', isDark ? 'true' : 'false');
            btn.textContent = isDark ? 'Przełącz na jasny motyw' : 'Przełącz na ciemny motyw';
            btn.setAttribute('title', isDark ? 'Włącz jaśniejszy motyw' : 'Włącz ciemniejszy motyw');
        }

        function applyTheme(theme, options = {}) {
            const persist = options.persist ?? userSelectedTheme;
            if (document.body) document.body.dataset.theme = theme;
            document.documentElement.style.setProperty('color-scheme', theme === 'dark' ? 'dark light' : 'light dark');
            updateThemeToggle(theme);
            if (persist) {
                try { localStorage.setItem(THEME_KEY, theme); userSelectedTheme = true; } catch (e) { }
            } else if (!userSelectedTheme) {
                try { localStorage.removeItem(THEME_KEY); } catch (e) { }
            }
        }

        function initTheme() {
            let storedTheme = null;
            try { storedTheme = localStorage.getItem(THEME_KEY); } catch (e) { storedTheme = null; }
            if (storedTheme === 'dark' || storedTheme === 'light') {
                userSelectedTheme = true;
                applyTheme(storedTheme, { persist: true });
            } else {
                const systemPrefersDark = prefersDarkQuery ? prefersDarkQuery.matches : false;
                applyTheme(systemPrefersDark ? 'dark' : 'light', { persist: false });
            }
            const btn = document.getElementById('themeToggle');
            if (btn) {
                btn.addEventListener('click', () => {
                    const next = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
                    applyTheme(next, { persist: true });
                });
            }
            if (prefersDarkQuery) {
                const listener = (event) => {
                    if (!userSelectedTheme) applyTheme(event.matches ? 'dark' : 'light', { persist: false });
                };
                if (prefersDarkQuery.addEventListener) prefersDarkQuery.addEventListener('change', listener);
                else if (prefersDarkQuery.addListener) prefersDarkQuery.addListener(listener);
            }
        }

        if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initTheme);
        else initTheme();

        let DIRTY = false;
        function markDirty() { DIRTY = true; }
        function setClean() { DIRTY = false; }
        const DRAFT_KEY = 'audyt-deklaracji-szkic';
        const CHECKPOINTS = [
            {
                id: 'isHTML', title: 'Format HTML', required: true, keywords: ['</'], critical: true,
                quote: '"Deklarację dostępności publikuje się w formacie HTML (...)"',
                para: 'Deklaracja powinna być opublikowana w formacie HTML, a nie jako obrazek czy PDF.'
            },
            {
                id: 'language', title: 'Język deklaracji', required: true, keywords: ['lang='], critical: true,
                quote: '"(...) deklaracja dostępności przygotowywana jest w tym samym języku, co treść strony internetowej lub aplikacji mobilnej, do której odnosi się deklaracja."',
                para: 'Deklaracja powinna być w tym samym języku co strona/aplikacja i zawierać odpowiedni atrybut lang w elemencie <html> oraz w sekcjach.'
            },
            {
                id: 'location', title: 'Miejsce opublikowania deklaracji dostępności i linku do niej', required: true, keywords: [], critical: true,
                quote: '"Deklarację dostępności strony internetowej publikuje się na stronie internetowej, której dotyczy deklaracja lub na innej, odpowiedniej stronie internetowej. Link do deklaracji dostępności jest opublikowany w taki sposób, aby był łatwo dostępny podczas nawigacji, np. w stopce strony."',
                para: 'Deklaracja powinna być opublikowana na stronie, której dotyczy, lub na innej odpowiedniej stronie, z łatwo dostępnym linkiem (np. w stopce).'
            },
            {
                id: 'content-tags-h', title: 'Użyto poprawnie znaczników nagłówków (od h1 do h6)', required: true, keywords: ['<h2>', '<h3>', '<h4>'], critical: true,
                quote: '"Do prezentacji treści w sekcjach wykorzystuje się odpowiednie elementy HTML: znaczniki nagłówków (od h1 do h6)"',
                para: 'Deklaracja powinna używać odpowiednich znaczników nagłówków (h1 do h6) do strukturyzacji treści.'
            },
            {
                id: 'content-tags-p', title: 'Użyto poprawnie znaczników akapitów', required: true, keywords: ['<p>'], critical: true,
                quote: '"Do prezentacji treści w sekcjach wykorzystuje się odpowiednie elementy HTML: (...) znaczniki akapitu (p)"',
                para: 'Deklaracja powinna używać znaczników <p> do oznaczania akapitów tekstu.'
            },
            {
                id: 'content-tags-list', title: 'Użyto poprawnie znaczników nieuporządkowanych i uporządkowanych', required: true, keywords: ['<ul>', '<ol>', '<li>'], critical: true,
                quote: '"Do prezentacji treści w sekcjach wykorzystuje się odpowiednie elementy HTML: (...) znaczniki list nieuporządkowanych (ul i li), znaczniki list uporządkowanych (ol i li)"',
                para: 'Deklaracja powinna używać znaczników <ul>, <ol> i <li> do tworzenia list punktowanych i numerowanych.'
            },
            {
                id: 'content-tags-section', title: 'Użyto poprawnie znaczników sekcji', required: true, keywords: ['<section', '<div'], critical: true,
                quote: '"Do prezentacji treści w sekcjach wykorzystuje się odpowiednie elementy HTML: (...) znaczniki section z atrybutem id, gdy wymagane jest oznaczenie treści identyfikatorem,"',
                para: 'Deklaracja powinna używać znaczników <section> lub <div> do grupowania treści, szczególnie gdy wymagane jest oznaczenie identyfikatorem.'
            },
            {
                id: 'content-tags-span', title: 'Użyto poprawnie znaczników span', required: true, keywords: ['<span'], critical: true,
                quote: '"Do prezentacji treści w sekcjach wykorzystuje się odpowiednie elementy HTML: (...) znaczniki span z atrybutem id, gdy wymagane jest oznaczenie fragmentu treści identyfikatorem"',
                para: 'Deklaracja powinna używać znaczników <span> do oznaczania fragmentów tekstu identyfikatorami, gdy jest to wymagane.'
            },
            {
                id: 'content-tags-time', title: 'Użyto poprawnie znacznika time do dat', required: true, keywords: ['<time'], critical: true,
                quote: '""Do prezentacji treści w sekcjach wykorzystuje się odpowiednie elementy HTML: (...) znaczniki time z atrybutem datetime, gdy podawane są daty"',
                para: 'Deklaracja powinna używać znacznika <time> z atrybutem datetime do oznaczania dat.'
            },
            {
                id: 'content-tags-a', title: 'Użyto poprawnie znaczników linków (a)', required: true, keywords: ['<a href='], critical: true,
                quote: '"Do prezentacji treści w sekcjach wykorzystuje się odpowiednie elementy HTML: (...) znaczniki a z atrybutem href, gdy podawane są linki"',
                para: 'Deklaracja powinna używać znaczników <a> z atrybutem href do oznaczania linków.'
            },
            {
                id: 'content-tags-abbr', title: 'Użyto poprawnie znaczników skrótów (abbr)', required: false, keywords: ['<abbr'], critical: false,
                quote: '"Do prezentacji treści w sekcjach wykorzystuje się odpowiednie elementy HTML: (...) znaczniki abbr z atrybutem title, gdy używane są skróty."',
                para: 'Jeśli w deklaracji używane są skróty, powinny być oznaczone znacznikami <abbr> z atrybutem title zawierającym pełną formę skrótu.'
            },
            {
                id: 'title', title: 'Tytuł deklaracji', required: true, keywords: ['deklaracja dostępności', '<h1>deklaracja dostępno', 'a11y-wstep'], critical: true,
                quote: '"Deklaracja rozpoczyna się tytułem. Tytuł deklaracji jest elementem obowiązkowym, który należy odwzorować wiernie. Tytuł deklaracji obejmuje się znacznikiem h1 lub h2, zgodnie z konwencją znakowania tytułów na stronie, na której publikowana jest deklaracja."',
                para: 'Deklaracja powinna zaczynać się nagłówkiem zawierającym dokładny tytuł „Deklaracja dostępności”. Użyj h1 lub h2.'
            },
            {
                id: 'intro', title: 'Oświadczenie wstępne (a11y-wstep)', required: true, keywords: ['a11y-wstep', 'zobowiązuje się zapewnić dostępność'], critical: true,
                quote: '"(...) oświadczenie o przestrzeganiu przepisów (...) Ma obowiązkowy wzór i jest oznaczane identyfikatorem a11y-wstep."',
                para: 'Sekcja wstępna powinna zawierać standardowy tekst o zobowiązaniu podmiotu do zapewnienia dostępności oraz wskazanie zakresu deklaracji. Powinna być oznaczona identyfikatorem a11y-wstep.'
            },
            {
                id: 'podmiot', title: 'Podmiot publiczny (a11y-podmiot)', required: true, keywords: ['Podmiot publiczny', 'a11y-podmiot'], critical: true,
                quote: '"W deklaracji dostępności dodaje się atrybuty id (identyfikatory) wymienione w tabeli (...)".',
                para: 'Nazwa podmiotu publicznego w sekcji z oświadczeniem wstępnym w znaczniku oznaczonym identyfikatorem a11y-podmiot.'
            },
            {
                id: 'zakres', title: 'Zakres deklaracji (a11y-zakres)', required: true, keywords: ['a11y-zakres'], critical: true,
                quote: '"W deklaracji dostępności dodaje się atrybuty id (identyfikatory) wymienione w tabeli (...)".',
                para: 'Zakres deklaracji (strona internetowa lub aplikacja mobilna) w sekcji z oświadczeniem wstępnym w znaczniku oznaczonym identyfikatorem a11y-zakres.'
            },
            {
                id: 'url', title: 'Adres strony/aplikacji, której dotyczy deklaracja', required: true, keywords: ['a11y-url'], critical: true,
                quote: '"W deklaracji dostępności dodaje się atrybuty id (identyfikatory) wymienione w tabeli (...)".',
                para: 'Adres URL strony internetowej lub strony, z której można pobrać aplikację mobilną, której dotyczy deklaracja, w sekcji z oświadczeniem wstępnym w znaczniku oznaczonym identyfikatorem a11y-url.'
            },
            {
                id: 'publicationDate', title: 'Data publikacji / aktualizacji', required: true, keywords: ['data publikacji', 'a11y-data-publikacja', 'ostatnia aktualizacja', 'a11y-data-aktualizacja'], critical: true,
                quote: '"(...) data pierwszej publikacji strony internetowej lub aplikacji mobilnej i data ostatniej, istotnej aktualizacji (modernizacji) tej strony lub tej aplikacji. Obie te daty są wymagane, a sposób ich zapisu musi wiernie odwzorowywać wzorzec (...) Daty zapisuje się w znaczniku "time", dodając odpowiednio identyfikatory a11y-data-publikacja oraz a11y-data-aktualizacja, w formacie: dzień (liczbowo) miesiąc (słownie) rok (liczbowo), np. 5 lutego 2020 r. lub dla wersji innych niż w języku polskim w formie najbardziej czytelnej, powszechnie używanej i zrozumiałej dla tego języka, i uzupełnia o atrybut "datetime", w którym ta sama data podawana jest w formacie rrrr-mm-dd.".',
                para: 'Podaj datę pierwszej publikacji oraz datę ostatniej istotnej aktualizacji deklaracji, używając znacznika <time> oznaczonego identyfikatorami a11y-data-publikacja i a11y-data-aktualizacja oraz atrybutu datetime.'
            },
            {
                id: 'status', title: 'Stan dostępności cyfrowej (a11y-status)', required: true, keywords: ['a11y-status', 'jest w pełni zgodna', 'częściowo zgodna', 'niezgodna'], critical: true,
                quote: '"Stan dostępności cyfrowej. Jest to obowiązkowa forma tego śródtytułu (...). Treść sekcji jest oznaczona identyfikatorem a11y-status."',
                para: 'Powinna być wyraźna informacja oznaczona identyfikatorem a11y-status, czy strona jest: w pełni zgodna, częściowo zgodna czy niezgodna z załącznikiem do ustawy.'
            },
            {
                id: 'niedostepne', title: 'Niedostępne treści (opis problemów)', required: false, keywords: ['Niedostępne treści', 'Niezgodność z załącznikiem', 'Nadmierne koszty'], critical: false,
                quote: '"Sekcję umieszcza się w deklaracji dostępności jedynie w przypadku gdy został wybrany stan dostępności cyfrowej „częściowo zgodna” lub „niezgodna”. Opis tej sekcji zaczyna się tytułem: Niedostępne treści. Jest to wymagana forma tego tytułu. Niedostępne treści należy wymienić w podziale na maksymalnie 3 grupy oznaczone odpowiednimi nagłówkami, zależnie od zidentyfikowanych problemów: Niezgodność z załącznikiem, Treści nieobjęte przepisami, Nadmierne koszty. (...) Treść wyników oceny lub link oznacza się identyfikatorem a11y-ocena."',
                para: 'Jeśli są elementy niedostępne, opisz je z podaniem lokalizacji (URL/podstrona), rodzaju błędu, alternatyw i możliwych obejść. Podziel na grupy: Niezgodność z załącznikiem, Treści nieobjęte przepisami, Nadmierne koszty. Oznacz treść identyfikatorem a11y-ocena.'
            },
            {
                id: 'preparation', title: 'Data i podstawa przygotowania deklaracji', required: true, keywords: ['a11y-data-sporzadzenie', 'data sporządzenia', 'a11y-data-przeglad', ], critical: true,
                quote: '"W sekcji wskazuje się daty sporządzenia deklaracji i jej aktualizacji oraz podstawę oceny (...) Element HTML z datą sporządzenia deklaracji uzupełnia się o atrybut id="a11y-data-sporzadzenie", a element z datą przeglądu i aktualizacji o atrybut id="a11y-data-przeglad""',
                para: 'Podaj datę sporządzenia i podstawę oceny oraz linki do raportów jeśli są. Użyj identyfikatorów a11y-data-sporzadzenie i a11y-data-przeglad. Daty powinny być w takim formacie jak w punkcie Data publikacji / aktualizacji z atrybutem datetime w znaczniku <time>.'
            },
            {
                id: 'udogodnienia', title: 'Udogodnienia, ograniczenia i inne informacje', required: false, keywords: ['Udogodnienia', 'Plany likwidacji błędów'], critical: false,
                quote: '"Udogodnienia, ograniczenia i inne informacje... o środkach zaradczych i planach likwidacji błędów."',
                para: 'Sekcja opcjonalna na dodatkowe informacje: plany naprawcze, oświadczenia o wyższym poziomie dostępności, itp.'
            },
            {
                id: 'shortcuts', title: 'Skróty klawiszowe (jeśli niestandardowe)', required: false, keywords: ['Skróty klawiszowe'], critical: false,
                quote: '"Informacje o niestandardowych skrótach klawiszowych obecnych na stronie internetowej"',
                para: 'Jeżeli strona używa niestandardowych skrótów klawiszowych, wymień je i opisz ich działanie.'
            },
            {
                id: 'feedback', title: 'Informacje zwrotne i dane kontaktowe', required: true, keywords: ['kontakt', 'koordynator dostępno', 'informacje zwrotne'], critical: true,
                quote: '"W sekcji podaje się nazwę komórki organizacyjnej lub imię i nazwisko osoby, do której zgłasza się problemy z dostępnością cyfrową oraz dane kontaktowych (telefon i adres e-mail) do tej komórki lub osoby, wraz z odpowiednimi identyfikatorami."',
                para: 'Podaj dane kontaktowe (telefon, e-mail) do osoby lub komórki odpowiedzialnej za dostępność oraz wskazówki, jak zgłaszać uwagi. Imię i nazwisko lub nazwa komórki powinny być oznaczona identyfikatorem a11y-kontakt, adres e-mail powinien być oznaczony identyfikatorem a11y-email, a numer telefonu identyfikatorem a11y-telefon.'
            },
            {
                id: 'procedures', title: 'Obsługa wniosków i skarg (a11y-procedura)', required: true, keywords: ['a11y-procedura', 'Obsługa wniosków i skarg'], critical: true,
                quote: '"Blok zawierający opis procedury objęty jest znacznikami sekcji (<section> lub <div>) i posiada identyfikator a11y-procedura. (...) Niezbędny jest opis procedury skargowej (...) w tym ewentualnie podanie danych podmiotu, do którego skarga może być złożona. (...) W tej podsekcji podawany jest także link do strony internetowej Rzecznika Praw Obywatelskich (...)."',
                para: 'Opisz jak składać wnioski i skargi, podaj terminy odpowiedzi oraz link do formularza rządowego i informacji o RPO. Sekcja powinna być oznaczona identyfikatorem a11y-procedura.'
            },
            {
                id: 'pozostale', title: 'Pozostałe informacje', required: true, keywords: ['Pozostałe informacje'], critical: true,
                quote: '"Sekcja jest wymagana. Zaczyna się śródtytułem: Pozostałe informacje. Jest to obowiązkowa forma tego śródtytułu i musi być wiernie odwzorowana."',
                para: 'Sekcja zawiera podsekcje o aplikacjach mobilnych, dostępności budynków i komunikacyjno-informacyjnej; podaj linki lub opisy.'
            },
            {
                id: 'aplikacje', title: 'Aplikacje mobilne (jeśli dotyczą)', required: false, keywords: ['a11y-aplikacje', 'Aplikacje mobilne'], critical: false,
                quote: '"Podsekcja objęta jest znacznikami sekcji (<section> lub <div>) i posiada identyfikator a11y-aplikacje. W treści deklaracji wymienia się aplikacje mobilne wraz z linkami do stron, na których można je pobrać. Dodaje się te linki do deklaracji dostępności tych aplikacji mobilnych."',
                para: 'Jeżeli posiadasz aplikacje mobilne, wymień je z linkami do sklepów i osobnymi deklaracjami dla każdej wersji. Sekcja powinna być oznaczona identyfikatorem a11y-aplikacje.'
            },
            {
                id: 'architektura', title: 'Dostępność architektoniczna (minimalny opis)', required: true, keywords: ['a11y-architektura', 'Dostępność architektoniczna', 'pętle indukcyjne'], critical: true,
                quote: '"Informacje zawarte w tym bloku to adres siedziby głównej podmiotu publicznego, opis jej dostępności architektonicznej lub link do innej strony internetowej, na której taki opis jest zamieszczony. Jeśli sekcja zawiera link do opisu dostępności architektonicznej, to jest on oznaczony identyfikatorem a11y-architektura-url)."',
                para: 'Podaj podstawowe informacje: adres siedziby, czy wejścia są dostępne, informacje o toaletach, parkingach, pętli indukcyjnej itp. (minimalny zakres). Oznacz sekcję identyfikatorem a11y-architektura, a jeśli sekcja zawiera link do opisu dostępności architektonicznej identyfikatorem to powinien być oznaczony a11y-architektura-url.'
            },
            {
                id: 'komunikacja', title: 'Dostępność komunikacyjno-informacyjna (PJM etc.)', required: true, keywords: ['a11y-komunikacja', 'tłumacz języka migowego'], critical: true,
                quote: '"W podsekcji podany jest opis dostępności komunikacyjno-informacyjnej podmiotu lub link do strony internetowej, na której taki opis jest zamieszczony. W opisie konieczne jest podanie informacji o możliwości (lub jej braku) skorzystania z pomocy tłumacza języka migowego w kontakcie z podmiotem za pośrednictwem środków komunikacji elektronicznej np. przez komunikator."',
                para: 'Opisz dostępność komunikacyjno-informacyjną podmiotu (np. czy jest możliwość skorzystania z tłumacza PJM) lub podaj link do takiego opisu. Oznacz sekcję identyfikatorem a11y-komunikacja.'
            }
        ];

        function e(tag, attrs = {}, ...children) {
            const el = document.createElement(tag);
            for (const k in attrs) { if (k === 'class') el.className = attrs[k]; else if (k === 'html') el.innerHTML = attrs[k]; else el.setAttribute(k, attrs[k]); }
            children.forEach(c => { if (typeof c === 'string') el.appendChild(document.createTextNode(c)); else if (c) el.appendChild(c); });
            return el;
        }

        function renderChecklist(state) {
            const sec = document.getElementById('checklistSection');
            sec.innerHTML = '';
            const card = e('div', { class: 'card p-3', role: 'region', 'aria-labelledby': 'checklistHeading' });
            card.appendChild(e('h2', { class: 'h5 mb-3', id: 'checklistHeading' }, 'Checklist — elementy deklaracji'));

            CHECKPOINTS.forEach((cp, index) => {
                const stateItem = state && state[cp.id] ? state[cp.id] : { prefill: null, choice: null, comment: '' };
                const descId = 'desc_' + cp.id;
                const badgeId = 'badge_' + cp.id;

                const fieldset = e('fieldset', { class: 'row-item', id: 'row_' + cp.id });
                fieldset.appendChild(e('legend', { class: 'row-title' }, `${index + 1}. ${cp.title}`));
                const reqClass = cp.required ? 'flag-required' : 'flag-optional';
                fieldset.appendChild(e('p', { class: 'row-description ' + reqClass, id: descId }, cp.required ? 'Pozycja wymagana' : 'Pozycja opcjonalna w konkretnych przypadkach'));

                const badgeWrapper = e('div', { class: 'badge-wrapper', id: badgeId, 'aria-live': 'polite' });
                if (stateItem.prefill === true) badgeWrapper.appendChild(e('span', { class: 'badge-found' },
                    e('i', { class: 'badge-icon bi bi-search-heart-fill', 'aria-hidden': 'true' }),
                    ' Wstępnie wykryto'));
                else if (stateItem.prefill === false) badgeWrapper.appendChild(e('span', { class: 'badge-miss' },
                    e('i', { class: 'badge-icon bi bi-exclamation-octagon-fill', 'aria-hidden': 'true' }),
                    ' Nie wykryto'));
                else badgeWrapper.appendChild(e('span', { class: 'badge-nd' },
                    e('i', { class: 'badge-icon bi bi-question-circle-fill', 'aria-hidden': 'true' }),
                    ' Brak analizy'));
                fieldset.appendChild(badgeWrapper);

                const choiceGroup = e('div', { class: 'choice-group', role: 'radiogroup', 'aria-describedby': descId, 'aria-label': `Ocena dla wymogu: ${cp.title}` });
                if (cp.required) choiceGroup.setAttribute('aria-required', 'true');
                const name = 'choice_' + cp.id;
                ['Spełnione', 'Niespełnione', 'Nie dotyczy'].forEach((lbl, i) => {
                    const v = i === 0 ? 'ok' : (i === 1 ? 'no' : 'na');
                    const input = e('input', { type: 'radio', name: name, value: v, 'aria-describedby': descId });
                    if (stateItem.choice === v) input.checked = true;
                    const labelEl = e('label', { class: 'choice-label', 'data-choice': v });
                    labelEl.appendChild(input);
                    labelEl.appendChild(e('span', { class: 'choice-label-text' }, lbl));
                    choiceGroup.appendChild(labelEl);
                });
                fieldset.appendChild(choiceGroup);

                const commentId = 'comment_' + cp.id;
                const comment = e('textarea', {
                    class: 'form-control form-control-sm choice-comment',
                    placeholder: 'Uwagi (opcjonalne)',
                    rows: '3',
                    id: commentId,
                    'aria-describedby': descId,
                    'aria-label': `Uwagi dotyczące wymogu: ${cp.title}`
                });
                comment.value = stateItem.comment || '';
                fieldset.appendChild(comment);

                const details = e('details', {});
                details.appendChild(e('summary', {}, 'Szczegóły z Warunków Technicznych (cytat + wytłumaczenie)'));
                details.appendChild(e('div', { class: 'mt-2' }, e('pre', { class: 'quote', role: 'note' }, cp.quote)));
                details.appendChild(e('div', { class: 'mt-2' }, e('strong', {}, 'Wytłumaczenie:'), e('div', { class: 'small-muted' }, cp.para)));
                fieldset.appendChild(details);

                card.appendChild(fieldset);
            });

            sec.appendChild(card);
            attachListeners();
            syncChoiceVisualState();
        }

        function attachListeners() {
            document.querySelectorAll('[id^="row_"]').forEach(row => {
                row.querySelectorAll('input[type=radio]').forEach(radio => {
                    radio.addEventListener('change', () => {
                        syncChoiceVisualState();
                        updateScore();
                        markDirty();
                    });
                });
                const comment = row.querySelector('textarea');
                if (comment) {
                    comment.addEventListener('input', () => {
                        updateScore();
                        markDirty();
                    });
                }
            });
            updateScore();
            checkSequence();
        }

        function syncChoiceVisualState() {
            document.querySelectorAll('.choice-label').forEach(label => label.removeAttribute('data-state'));
            document.querySelectorAll('.choice-label input[type="radio"]').forEach(input => {
                if (input.checked) {
                    const label = input.closest('.choice-label');
                    if (label) label.setAttribute('data-state', 'checked');
                }
            });
        }

        function detectPrefill(text) {
            if (!text) return null;
            const lc = text.toLowerCase();
            const res = {};
            CHECKPOINTS.forEach(cp => {
                let found = false;
                if (cp.keywords && cp.keywords.length) found = cp.keywords.some(k => lc.includes(k.toLowerCase()));
                res[cp.id] = found;
            });
            return res;
        }

        function checkSequence() {
            const seqEl = document.getElementById('sequenceResult');
            if (!seqEl) return;
            const text = document.getElementById('declarationText').value || '';
            seqEl.classList.remove('status-positive', 'status-warning', 'status-danger');
            if (!text.trim()) {
                seqEl.textContent = 'Brak wklejonej treści do analizy kolejności.';
                seqEl.classList.add('status-warning');
                return;
            }
            const expected = ['Deklaracja dostępności', 'Stan dostępności cyfrowej', 'Niedostępne treści', 'Przygotowanie deklaracji dostępności', 'Udogodnienia, ograniczenia i inne informacje', 'Skróty klawiszowe', 'Informacje zwrotne i dane kontaktowe', 'Obsługa wniosków i skarg związanych z dostępnością', 'Pozostałe informacje', 'Aplikacje mobilne', 'Dostępność architektoniczna', 'Dostępność komunikacyjno-informacyjna'];
            const lc = text.toLowerCase();
            const foundPositions = expected.map(title => ({ title, idx: lc.indexOf(title.toLowerCase()) }));
            const foundOnly = foundPositions.filter(f => f.idx !== -1).sort((a, b) => a.idx - b.idx);
            let ok = true;
            for (let i = 0; i < foundOnly.length - 1; i++) {
                const ei = expected.indexOf(foundOnly[i].title);
                const ni = expected.indexOf(foundOnly[i + 1].title);
                if (ni < ei) { ok = false; break; }
            }
            let msg = '';
            if (foundOnly.length === 0) {
                msg = 'Nie wykryto nagłówków z oczekiwanej listy.';
                seqEl.classList.add('status-danger');
            } else {
                msg = `Wykryto ${foundOnly.length}/${expected.length} nagłówków. ` + (ok ? 'Kolejność wykrytych sekcji zgodna.' : 'Kolejność może być nieprawidłowa.');
                seqEl.classList.add(ok ? 'status-positive' : 'status-warning');
            }
            seqEl.textContent = msg;
        }

        function updateScore() {
            let considered = 0, ok = 0;
            const missing = [];
            const unanswered = [];
            CHECKPOINTS.forEach(cp => {
                const name = 'choice_' + cp.id;
                const chosen = document.querySelector('input[name="' + name + '"]:checked');
                const commentEl = document.querySelector('#row_' + cp.id + ' textarea');
                const comment = commentEl ? (commentEl.value || '') : '';
                if (chosen) {
                    if (chosen.value === 'na') { }
                    else {
                        considered++;
                        if (chosen.value === 'ok') ok++;
                        else if (chosen.value === 'no') {
                            missing.push(cp.title + ' — ' + (cp.critical ? 'krytyczny brak. ' : '') + (comment ? 'Uwagi: ' + comment : ''));
                        }
                    }
                } else {
                    unanswered.push(cp.title);
                }
            });
            let percDisplay = '—', label = '—', percValue = null;
            if (considered > 0) {
                percValue = Math.round((ok / considered) * 100);
                percDisplay = percValue + ' %';
                if (percValue === 100) label = 'Zgodna z wytycznymi';
                else label = 'Brak zgodności z wymaganiami';
            } else if (missing.length > 0) {
                label = 'Brak ocenionych pozycji';
            }
            const percEl = document.getElementById('scorePerc');
            const labelEl = document.getElementById('scoreLabel');
            [percEl, labelEl].forEach(el => el.classList.remove('status-positive', 'status-warning', 'status-danger'));
            if (percValue !== null) {
                if (percValue === 100) {
                    percEl.classList.add('status-positive');
                    labelEl.classList.add('status-positive');
                } else if (percValue >= 90) {
                    percEl.classList.add('status-warning');
                    labelEl.classList.add('status-warning');
                } else {
                    percEl.classList.add('status-danger');
                    labelEl.classList.add('status-danger');
                }
            }
            percEl.textContent = percDisplay;
            labelEl.textContent = label;
            const ml = document.getElementById('missingList');
            ml.innerHTML = '';
            if (missing.length === 0 && unanswered.length === 0) {
                ml.appendChild(e('li', {}, 'Brak braków — wszystkie ocenione pozycje spełniają wymagania.'));
            } else {
                missing.forEach(m => ml.appendChild(e('li', {}, m)));
                if (unanswered.length) {
                    const summary = unanswered.slice(0, 8).join(', ') + (unanswered.length > 8 ? `, … (łącznie ${unanswered.length} pozycji)` : '');
                    ml.appendChild(e('li', {}, 'Brak oceny dla: ' + summary));
                }
            }
        }

        function collectState() {
            const obj = {
                meta: {
                    entity: document.getElementById('entityName').value || '',
                    auditDate: document.getElementById('auditDate').value || '',
                    author: document.getElementById('authorName') ? (document.getElementById('authorName').value || '') : ''
                },
                items: {}
            };
            let considered = 0, ok = 0;
            const detectedPrefill = detectPrefill(document.getElementById('declarationText').value || '');
            CHECKPOINTS.forEach(cp => {
                const name = 'choice_' + cp.id;
                const chosen = document.querySelector('input[name="' + name + '"]:checked');
                const commentEl = document.querySelector('#row_' + cp.id + ' textarea');
                const comment = commentEl ? (commentEl.value || '') : '';
                const prefill = detectedPrefill ? !!detectedPrefill[cp.id] : null;
                const choiceVal = chosen ? chosen.value : null;
                if (choiceVal && choiceVal !== 'na') {
                    considered++;
                    if (choiceVal === 'ok') ok++;
                }
                obj.items[cp.id] = { title: cp.title, required: !!cp.required, choice: choiceVal, comment: comment, prefill: prefill };
            });
            let percent = '—', label = '—';
            if (considered > 0) {
                percent = Math.round((ok / considered) * 100);
                if (percent === 100) label = 'Zgodna z wytycznymi';
                else if (percent >= 90) label = 'Wysoki poziom zgodności — uzupełnij wskazane braki';
                else if (percent >= 70) label = 'Częściowa zgodność — wymagane działania naprawcze';
                else label = 'Brak zgodności z wymaganiami';
            } else {
                label = 'Brak ocenionych pozycji';
            }
            obj.summary = { percent, label };
            return obj;
        }

        document.getElementById('prefillBtn').addEventListener('click', () => {
            const txt = document.getElementById('declarationText').value || '';
            const pre = detectPrefill(txt);
            const state = {};
            CHECKPOINTS.forEach(cp => state[cp.id] = { prefill: pre ? pre[cp.id] : null, choice: null, comment: '' });
            renderChecklist(state);
            checkSequence();
        });

        document.getElementById('clearBtn').addEventListener('click', () => {
            document.getElementById('declarationText').value = '';
            renderChecklist();
            document.getElementById('scorePerc').textContent = '—';
            document.getElementById('scoreLabel').textContent = '—';
            document.getElementById('missingList').innerHTML = '';
            markDirty();
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            if (!confirm('Zresetować formularz?')) return;
            document.getElementById('declarationText').value = '';
            document.getElementById('entityName').value = '';
            const auditInput = document.getElementById('auditDate'); if (auditInput) auditInput.value = '';
            const authorInput = document.getElementById('authorName'); if (authorInput) authorInput.value = '';
            renderChecklist();
            updateScore();
            setClean();
            try { localStorage.removeItem(DRAFT_KEY); } catch (e) {}
        });

        document.getElementById('exportJsonBtn').addEventListener('click', () => {
            const st = collectState();
            const val = validateBeforeExport(st);
            if (!val.ok) {
                const proceed = confirm(val.message + '\n\nKliknij „OK”, aby eksportować mimo to, lub „Anuluj”, aby przerwać.');
                if (!proceed) return;
            }
            const data = st;
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'audyt-deklaracji-' + (new Date().toISOString().slice(0, 10)) + '.json';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
            setClean();
        });

        document.getElementById('importJsonBtn').addEventListener('click', () => {
            document.getElementById('importJson').click();
        });

        document.getElementById('importJson').addEventListener('change', (ev) => {
            const f = ev.target.files[0];
            if (!f) return;
            const r = new FileReader();
            r.onload = () => {
                try {
                    const d = JSON.parse(r.result);
                    if (d.rawDeclaration) document.getElementById('declarationText').value = d.rawDeclaration;
                    if (d.meta && d.meta.entity) document.getElementById('entityName').value = d.meta.entity;
                    if (d.meta && 'auditDate' in d.meta) document.getElementById('auditDate').value = d.meta.auditDate || '';
                    if (d.meta && 'author' in d.meta && document.getElementById('authorName')) document.getElementById('authorName').value = d.meta.author || '';
                    const state = {};
                    CHECKPOINTS.forEach(cp => {
                        const it = d.items && d.items[cp.id] ? d.items[cp.id] : { prefill: null, choice: null, comment: '' };
                        state[cp.id] = { prefill: it.prefill, choice: it.choice, comment: it.comment || '' };
                    });
                    renderChecklist(state);
                    Object.keys(state).forEach(id => {
                        const choice = state[id].choice;
                        if (choice) {
                            const radio = document.querySelector('input[name="choice_' + id + '"][value="' + choice + '"]');
                            if (radio) radio.checked = true;
                        }
                        const commentEl2 = document.querySelector('#row_' + id + ' textarea');
                        if (commentEl2) commentEl2.value = state[id].comment || '';
                    });
                    syncChoiceVisualState();
                    updateScore();
                    checkSequence();
                } catch (e) {
                    alert('Błąd importu JSON: ' + e.message);
                }
            };
            r.readAsText(f);
            ev.target.value = '';
        });

        
        
        function saveDraft() {
            const st = collectState();
            st.rawDeclaration = document.getElementById('declarationText').value || '';
            st.savedAt = new Date().toISOString();
            try {
                localStorage.setItem(DRAFT_KEY, JSON.stringify(st));
                setClean();
                alert('Szkic zapisany lokalnie.');
            } catch (e) {
                alert('Nie udało się zapisać szkicu: ' + e.message);
            }
        }

        
        
        function restoreDraft(d) {
            try {
                if (!d) return;
                if (d.rawDeclaration) document.getElementById('declarationText').value = d.rawDeclaration;
                if (d.meta) {
                    if ('entity' in d.meta) document.getElementById('entityName').value = d.meta.entity || '';
                    if ('auditDate' in d.meta) document.getElementById('auditDate').value = d.meta.auditDate || '';
                    if ('author' in d.meta && document.getElementById('authorName')) document.getElementById('authorName').value = d.meta.author || '';
                }
                const state = {};
                CHECKPOINTS.forEach(cp => {
                    const it = d.items && d.items[cp.id] ? d.items[cp.id] : { prefill: null, choice: null, comment: '' };
                    state[cp.id] = { prefill: it.prefill, choice: it.choice, comment: it.comment || '' };
                });
                renderChecklist(state);
                Object.keys(state).forEach(id => {
                    const choice = state[id].choice;
                    if (choice) {
                        const radio = document.querySelector('input[name="choice_' + id + '"][value="' + choice + '"]');
                        if (radio) radio.checked = true;
                    }
                    const commentEl2 = document.querySelector('#row_' + id + ' textarea');
                    if (commentEl2) commentEl2.value = state[id].comment || '';
                });
                syncChoiceVisualState();
                updateScore();
                checkSequence();
                setClean();
            } catch (e) {
                alert('Nie udało się wczytać szkicu: ' + e.message);
            }
        }

    document.getElementById('saveDraftBtn').addEventListener('click', saveDraft);

        document.getElementById('exportHtmlBtn').addEventListener('click', () => {
            const st = collectState();
            const val = validateBeforeExport(st);
            if (!val.ok) {
                const proceed = confirm(val.message + '\n\nKliknij „OK”, aby eksportować mimo to, lub „Anuluj”, aby przerwać.');
                if (!proceed) return;
            }
            const entity = st.meta.entity || '—';
            const auditDate = st.meta.auditDate || '—';
            const author = st.meta.author || '—';
            let html = `<!doctype html><html><head><meta charset=\"utf-8\"><title>Raport audytu deklaracji — ${escapeHtml(entity)}</title><style>body{font-family:Arial,Helvetica,sans-serif;padding:20px;color:#111}h1{font-size:18px}table{border-collapse:collapse;width:100%}td,th{border:1px solid #ccc;padding:8px;text-align:left}.bad{color:#b00}.comment{white-space:pre-wrap}</style></head><body><h1>Raport audytu deklaracji dostępności</h1><p><strong>Podmiot / strona:</strong> ${escapeHtml(entity)}<br/><strong>Data audytu:</strong> ${escapeHtml(auditDate)}<br/><strong>Autor raportu:</strong> ${escapeHtml(author)}</p><h2>Podsumowanie</h2><p><strong>Procent zgodności:</strong> ${st.summary.percent === '—' ? '—' : st.summary.percent + '%'}<br/><strong>Ocena:</strong> ${escapeHtml(st.summary.label)}</p><h2>Wykaz pozycji</h2><table><thead><tr><th>Wymóg</th><th>Wynik</th><th>Wymagany</th></tr></thead><tbody>`;
            for (const cp of CHECKPOINTS) {
                const it = st.items[cp.id];
                const choiceLabel = it.choice === 'ok' ? 'Spełnione' : (it.choice === 'no' ? 'Niespełnione' : (it.choice === 'na' ? 'Nie dotyczy' : 'Nie zweryfikowano'));
                html += `<tr><td>${escapeHtml(cp.title)}</td><td>${escapeHtml(choiceLabel)}</td><td>${cp.required ? 'Tak' : 'Nie'}</td></tr>`;
            }
            html += `</tbody></table>`;
            const notes = [];
            for (const cp of CHECKPOINTS) {
                const it = st.items[cp.id];
                const c = (it.comment || '').trim();
                if (c) notes.push(`${cp.title}: ${c}`);
            }
            if (notes.length) {
                html += `<h2>Uwagi</h2><ul>`;
                notes.forEach(n => html += `<li class=\"comment\">${escapeHtml(n)}</li>`);
                html += `</ul>`;
            }
            html += `</body></html>`;
            const blob = new Blob([html], { type: 'text/html' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'raport-audyt-deklaracji-' + document.getElementById('auditDate').value + '.html';
            document.body.appendChild(a);
            a.click();
            a.remove();
            setClean();
        });

        function escapeHtml(s) {
            if (!s) return '';
            return s.replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;');
        }

        function validateBeforeExport(st) {
            const missingAnswers = [];
            const missingComments = [];
            for (const cp of CHECKPOINTS) {
                const it = st.items[cp.id] || {};
                if (!it.choice) {
                    missingAnswers.push(cp.title);
                } else if (it.choice === 'no') {
                    const c = (it.comment || '').trim();
                    if (!c) missingComments.push(cp.title);
                }
            }
            if (missingAnswers.length === 0 && missingComments.length === 0) return { ok: true, message: '' };

            const summarize = (arr) => {
                const shown = arr.slice(0, 5).map(t => '• ' + t).join('\n');
                const more = arr.length > 5 ? `\n… i ${arr.length - 5} więcej` : '';
                return shown + more;
            };

            let msg = 'Ostrzeżenie przed eksportem:\n';
            if (missingAnswers.length) {
                msg += `- Niewybrane odpowiedzi (${missingAnswers.length}):\n` + summarize(missingAnswers) + '\n';
            }
            if (missingComments.length) {
                msg += `- „Niespełnione” bez uwagi (${missingComments.length}):\n` + summarize(missingComments) + '\n';
            }
            msg += '\nNie eksportuj — Anuluj\nEksportuj mimo to — OK';
            return { ok: false, message: msg };
        }

        ['entityName','auditDate','authorName','declarationText'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('input', markDirty);
            if (el && el.type === 'date') el.addEventListener('change', markDirty);
        });

        
        
        
        window.addEventListener('beforeunload', (e) => {
            if (!DIRTY) return;
            const msg = 'Masz niezapisane zmiany audytu. Jeśli teraz zamkniesz lub odświeżysz, utracisz postęp.';
            e.preventDefault();
            e.returnValue = msg;
            return msg;
        });

        renderChecklist();

        try {
            const draftRaw = localStorage.getItem(DRAFT_KEY);
            if (draftRaw) {
                const d = JSON.parse(draftRaw);
                const info = d && d.meta ? (d.meta.entity ? ` dla podmiotu: ${d.meta.entity}` : '') : '';
                const ask = confirm(`Wykryto zapisany szkic${info}.\nCzy chcesz go wczytać teraz?`);
                if (ask) restoreDraft(d);
            }
        } catch (e) {}
    </script>
</body>

</html>
